#!/usr/bin/env python3

'''

get chromatin contacts, based on one anchors, or a BED -> gene promoter

'''

import sys
import os
import argparse
import logging

script_path = os.path.dirname(os.path.realpath(__file__))

sys.path.append(os.path.join(script_path, '../'))
import tehiclib

sys.path.append(os.path.join(script_path, '../tehiclib'))
from miniglbase3 import glload

# Command-line options;
def prepare_parser():
    defaults = {
        '-w': 5000,
        '-t': 3
        }

    exmp = 'Example usage: contactZ -c peaks.bed -i reads.bedpe -n sample_label -g genome'

    description = 'Calculate a contact-Z score for '

    parser = argparse.ArgumentParser(prog='contactZ', description=description, epilog=exmp)

    # Optional:
    optional = parser._action_groups.pop()
    optional.add_argument('-w', '--window', action='store', type=int, default=defaults['-w'], required=False, help='Window size (in base pairs) to look around the BED, default={}'.format(defaults['-w']))
    optional.add_argument('-t', '--threshold', action='store', type=int, default=defaults['-t'], required=False, help='Thresold (in reads) to call a contact default={}'.format(defaults['-t']))

    #optional.add_argument('-g', '--genome', nargs=1, required=False, help='Optional, but requried if "tes" or "genes" in --mode. Genome assembly to use, valid genomes: {}'.format(tehiclib.common.valid_assemblies))

    required = parser.add_argument_group('required arguments')

    required.add_argument('-p', '--inpeaksbed', nargs=1, required=True, help='A BED file contining peaks or sites to consider')
    required.add_argument('-i', '--inreadsbedpe', nargs=1, required=True, help='A BEDPE file containing the HiC reads, from one side to the other')
    required.add_argument('-n', '--label', nargs=1, required=True, help='A label for this sample to save the data to')

    parser._action_groups.append(optional)

    logging.basicConfig(level=logging.INFO,
                    format='%(levelname)-8s: %(message)s',
                    datefmt='%m-%d %H:%M')

    parser.log = logging.getLogger('contactZ')

    return parser

def main():
    assert sys.version_info >= (3, 7), 'Python >=3.7 is required'

    script_path = os.path.dirname(os.path.realpath(__file__))
    parser = prepare_parser()
    args = parser.parse_args()

    log = parser.log
    args.mode = args.mode[0]

    log.info('getContacts')
    log.info('Arguments:')
    log.info('  inreadsbedpe: %s' % args.inreadsbedpe)
    log.info('  inpeaksbed: %s' % args.inpeaksbed)
    log.info('  label: %s' % args.label)
    log.info('  window: %s' % args.window)
    log.info('  threshold: {0} reads'.format(args.threshold))

    te_hic = tehiclib.measure_contacts(logger=log)
    contacts = te_hic.bed_to_bed(
        reads=args.inreadsbedpe[0],
        bed=args.inpeaksbed[0],
        window=args.window,
        outfile=args.outtsv[0],
        threshold=args.threshold,
        )

    print(contacts)
    #cZ = tehiclib.

    return

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        sys.stderr.write("User interrupt\n")
        sys.exit(0)
